<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Creazione Cliente Diretta</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
    h1 { color: #2c3e50; }
    .form-group { margin-bottom: 15px; }
    label { display: block; margin-bottom: 5px; font-weight: bold; }
    input, select, textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
    button { background: #3498db; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; }
    button:hover { background: #2980b9; }
    .error { color: red; padding: 10px; background: #ffebee; border-radius: 4px; margin: 10px 0; }
    .success { color: green; padding: 10px; background: #e8f5e9; border-radius: 4px; margin: 10px 0; }
    .result { margin-top: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 4px; display: none; }
    pre { background: #f8f8f8; padding: 10px; overflow: auto; }
  </style>
</head>
<body>
  <h1>Creazione Cliente SQL Diretta</h1>
  <p>Utilizza questo form per inserire un cliente direttamente nel database tramite SQL.</p>
  
  <div id="clientForm">
    <div class="form-group">
      <label for="type">Tipo Cliente*</label>
      <select id="type" required>
        <option value="buyer">Acquirente</option>
        <option value="seller">Venditore</option>
      </select>
    </div>
    
    <div class="form-group">
      <label for="salutation">Salutazione</label>
      <select id="salutation">
        <option value="egr_dott">Egr. Dott.</option>
        <option value="gentma_sigra">Gent.ma Sig.ra</option>
        <option value="egr_avv">Egr. Avv.to</option>
        <option value="caro">Caro</option>
        <option value="cara">Cara</option>
        <option value="ciao">Ciao</option>
      </select>
    </div>
    
    <div class="form-group">
      <label for="firstName">Nome*</label>
      <input type="text" id="firstName" required>
    </div>
    
    <div class="form-group">
      <label for="lastName">Cognome*</label>
      <input type="text" id="lastName" required>
    </div>
    
    <div class="form-group">
      <label for="phone">Telefono* (con prefisso, es. 39340...)</label>
      <input type="text" id="phone" placeholder="393401234567" required>
    </div>
    
    <div class="form-group">
      <label for="email">Email</label>
      <input type="email" id="email">
    </div>
    
    <div class="form-group">
      <label for="religion">Religione</label>
      <input type="text" id="religion">
    </div>
    
    <div class="form-group">
      <label for="contractType">Tipo Contratto</label>
      <select id="contractType">
        <option value="">-- Seleziona --</option>
        <option value="sale">Vendita</option>
        <option value="rent">Affitto</option>
      </select>
    </div>
    
    <div class="form-group">
      <label for="notes">Note</label>
      <textarea id="notes" rows="3"></textarea>
    </div>
    
    <div class="form-group">
      <input type="checkbox" id="isFriend">
      <label for="isFriend" style="display: inline;">Cliente amico</label>
    </div>
    
    <!-- Campi specifici buyer -->
    <div id="buyerFields" style="border: 1px solid #eee; padding: 15px; margin-top: 20px;">
      <h3>Preferenze Acquirente</h3>
      
      <div class="form-group">
        <label for="minSize">Dimensione Minima (mq)</label>
        <input type="number" id="minSize">
      </div>
      
      <div class="form-group">
        <label for="maxPrice">Prezzo Massimo (€)</label>
        <input type="number" id="maxPrice">
      </div>
      
      <div class="form-group">
        <label for="urgency">Urgenza (1-5)</label>
        <input type="number" id="urgency" min="1" max="5" value="3">
      </div>
      
      <div class="form-group">
        <label for="rating">Rating (1-5)</label>
        <input type="number" id="rating" min="1" max="5" value="3">
      </div>
      
      <div class="form-group">
        <label for="searchNotes">Note Ricerca</label>
        <textarea id="searchNotes" rows="2"></textarea>
      </div>
    </div>
    
    <!-- Campi specifici seller -->
    <div id="sellerFields" style="border: 1px solid #eee; padding: 15px; margin-top: 20px; display: none;">
      <h3>Dettagli Venditore</h3>
      
      <div class="form-group">
        <label for="propertyId">ID Proprietà (se disponibile)</label>
        <input type="number" id="propertyId">
      </div>
    </div>
    
    <button type="button" id="submitButton">Salva Cliente</button>
  </div>
  
  <div id="result" class="result">
    <h3>Risultato</h3>
    <div id="statusMessage"></div>
    <pre id="responseContent"></pre>
  </div>
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Gestione visualizzazione campi buyer/seller
      const typeSelect = document.getElementById('type');
      const buyerFields = document.getElementById('buyerFields');
      const sellerFields = document.getElementById('sellerFields');
      
      typeSelect.addEventListener('change', function() {
        if (this.value === 'buyer') {
          buyerFields.style.display = 'block';
          sellerFields.style.display = 'none';
        } else {
          buyerFields.style.display = 'none';
          sellerFields.style.display = 'block';
        }
      });
      
      // Gestione invio form
      const submitButton = document.getElementById('submitButton');
      const resultDiv = document.getElementById('result');
      const statusMessage = document.getElementById('statusMessage');
      const responseContent = document.getElementById('responseContent');
      
      submitButton.addEventListener('click', async function() {
        try {
          // Costruisci oggetto dati cliente
          const clientData = {
            type: document.getElementById('type').value,
            salutation: document.getElementById('salutation').value,
            firstName: document.getElementById('firstName').value, 
            lastName: document.getElementById('lastName').value,
            phone: document.getElementById('phone').value,
            email: document.getElementById('email').value || "",
            religion: document.getElementById('religion').value || "",
            contractType: document.getElementById('contractType').value || null,
            notes: document.getElementById('notes').value || "",
            isFriend: document.getElementById('isFriend').checked
          };
          
          // Validazione dati minimi
          if (!clientData.firstName || !clientData.lastName || !clientData.phone) {
            alert('Nome, cognome e telefono sono campi obbligatori!');
            return;
          }
          
          // Aggiungi preferenze buyer
          if (clientData.type === 'buyer') {
            clientData.buyer = {
              minSize: document.getElementById('minSize').value ? parseInt(document.getElementById('minSize').value) : null,
              maxPrice: document.getElementById('maxPrice').value ? parseInt(document.getElementById('maxPrice').value) : null,
              urgency: parseInt(document.getElementById('urgency').value) || 3,
              rating: parseInt(document.getElementById('rating').value) || 3,
              searchNotes: document.getElementById('searchNotes').value || ""
            };
          }
          
          // Aggiungi dati seller
          if (clientData.type === 'seller') {
            clientData.seller = {
              propertyId: document.getElementById('propertyId').value ? parseInt(document.getElementById('propertyId').value) : null
            };
          }
          
          console.log('Invio dati cliente:', clientData);
          
          // Invia richiesta al server
          const response = await fetch('/api/sql-client-direct', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(clientData)
          });
          
          // Gestisci risposta
          const result = await response.json();
          
          // Visualizza risultato
          resultDiv.style.display = 'block';
          
          if (response.ok) {
            statusMessage.innerHTML = `✅ Cliente creato con successo! ID: ${result.client?.id || 'N/A'}`;
            statusMessage.className = 'success';
          } else {
            statusMessage.innerHTML = `❌ Errore: ${result.error || 'Errore durante il salvataggio'}`;
            statusMessage.className = 'error';
          }
          
          responseContent.textContent = JSON.stringify(result, null, 2);
          
        } catch (error) {
          console.error('Errore:', error);
          
          resultDiv.style.display = 'block';
          statusMessage.innerHTML = `❌ Errore: ${error.message}`;
          statusMessage.className = 'error';
          responseContent.textContent = error.stack;
        }
      });
    });
  </script>
</body>
</html>