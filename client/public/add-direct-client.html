<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Aggiungi Cliente Diretto</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; max-width: 800px; }
    h1 { color: #2c3e50; }
    form { display: flex; flex-direction: column; gap: 15px; }
    label { font-weight: bold; margin-bottom: 5px; display: block; }
    input, select, textarea { padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
    button { background: #3498db; color: white; padding: 10px; border: none; border-radius: 4px; cursor: pointer; }
    button:hover { background: #2980b9; }
    .result { margin-top: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 4px; }
    .error { color: red; }
    .success { color: green; }
  </style>
</head>
<body>
  <h1>Aggiungi Cliente (Inserimento Diretto)</h1>
  <p>Questo tool inserisce un cliente direttamente nel database, bypassando la validazione frontend.</p>
  
  <form id="clientForm">
    <div>
      <label for="type">Tipo Cliente*</label>
      <select id="type" name="type" required>
        <option value="buyer">Acquirente (Buyer)</option>
        <option value="seller">Venditore (Seller)</option>
      </select>
    </div>
    
    <div>
      <label for="salutation">Salutazione</label>
      <select id="salutation" name="salutation">
        <option value="egr_dott">Egr. Dott.</option>
        <option value="gent_sig_ra">Gent.ma Sig.ra</option>
        <option value="egr_avv">Egr. Avv.to</option>
        <option value="caro">Caro</option>
        <option value="cara">Cara</option>
        <option value="ciao">Ciao</option>
      </select>
    </div>
    
    <div>
      <label for="firstName">Nome*</label>
      <input type="text" id="firstName" name="firstName" required>
    </div>
    
    <div>
      <label for="lastName">Cognome*</label>
      <input type="text" id="lastName" name="lastName" required>
    </div>
    
    <div>
      <label for="phone">Telefono*</label>
      <input type="text" id="phone" name="phone" required>
    </div>
    
    <div>
      <label for="email">Email</label>
      <input type="email" id="email" name="email">
    </div>
    
    <div>
      <label for="religion">Religione</label>
      <input type="text" id="religion" name="religion">
    </div>
    
    <div>
      <label for="contractType">Tipo Contratto</label>
      <select id="contractType" name="contractType">
        <option value="">-- Seleziona --</option>
        <option value="sale">Vendita</option>
        <option value="rent">Affitto</option>
      </select>
    </div>
    
    <div>
      <label for="notes">Note</label>
      <textarea id="notes" name="notes" rows="3"></textarea>
    </div>
    
    <div>
      <input type="checkbox" id="isFriend" name="isFriend">
      <label for="isFriend">Cliente amico</label>
    </div>
    
    <!-- Campi specifici per buyer -->
    <div id="buyerFields" style="border: 1px solid #eee; padding: 15px; margin-top: 10px;">
      <h3>Preferenze Acquirente</h3>
      
      <div>
        <label for="minSize">Dimensione Minima (mq)</label>
        <input type="number" id="minSize" name="minSize">
      </div>
      
      <div>
        <label for="maxPrice">Prezzo Massimo (€)</label>
        <input type="number" id="maxPrice" name="maxPrice">
      </div>
      
      <div>
        <label for="urgency">Urgenza (1-5)</label>
        <input type="number" id="urgency" name="urgency" min="1" max="5" value="3">
      </div>
      
      <div>
        <label for="rating">Rating (1-5)</label>
        <input type="number" id="rating" name="rating" min="1" max="5" value="3">
      </div>
      
      <div>
        <label for="searchNotes">Note Ricerca</label>
        <textarea id="searchNotes" name="searchNotes" rows="2"></textarea>
      </div>
    </div>
    
    <!-- Campi specifici per seller -->
    <div id="sellerFields" style="border: 1px solid #eee; padding: 15px; margin-top: 10px; display: none;">
      <h3>Dettagli Venditore</h3>
      
      <div>
        <label for="propertyId">ID Proprietà (se disponibile)</label>
        <input type="number" id="propertyId" name="propertyId">
      </div>
    </div>
    
    <button type="submit">Salva Cliente</button>
  </form>
  
  <div id="result" class="result" style="display: none;"></div>
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Mostra/nascondi campi in base al tipo di cliente
      const typeSelect = document.getElementById('type');
      const buyerFields = document.getElementById('buyerFields');
      const sellerFields = document.getElementById('sellerFields');
      
      typeSelect.addEventListener('change', function() {
        if (this.value === 'buyer') {
          buyerFields.style.display = 'block';
          sellerFields.style.display = 'none';
        } else {
          buyerFields.style.display = 'none';
          sellerFields.style.display = 'block';
        }
      });
      
      // Gestione form
      const clientForm = document.getElementById('clientForm');
      const resultDiv = document.getElementById('result');
      
      clientForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // Raccogli dati form
        const formData = new FormData(clientForm);
        const clientData = {
          type: formData.get('type'),
          salutation: formData.get('salutation'),
          firstName: formData.get('firstName'),
          lastName: formData.get('lastName'),
          phone: formData.get('phone'),
          email: formData.get('email') || "",
          religion: formData.get('religion') || "",
          contractType: formData.get('contractType') || null,
          notes: formData.get('notes') || "",
          isFriend: formData.get('isFriend') === 'on'
        };
        
        // Aggiunge dati buyer se necessario
        if (clientData.type === 'buyer') {
          clientData.buyer = {
            minSize: formData.get('minSize') ? parseInt(formData.get('minSize')) : null,
            maxPrice: formData.get('maxPrice') ? parseInt(formData.get('maxPrice')) : null,
            urgency: parseInt(formData.get('urgency')) || 3,
            rating: parseInt(formData.get('rating')) || 3,
            searchNotes: formData.get('searchNotes') || ""
          };
        }
        
        // Aggiunge dati seller se necessario
        if (clientData.type === 'seller') {
          clientData.seller = {
            propertyId: formData.get('propertyId') ? parseInt(formData.get('propertyId')) : null
          };
        }
        
        console.log('Dati client da inviare:', clientData);
        
        try {
          // Prova l'endpoint diretto
          const response = await fetch('/api/direct-clients/create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(clientData)
          });
          
          const result = await response.json();
          
          if (!response.ok) {
            throw new Error(result.error || 'Errore durante il salvataggio del cliente');
          }
          
          resultDiv.innerHTML = `
            <div class="success">
              <h3>✅ Cliente creato con successo!</h3>
              <p>ID: ${result.client?.id}</p>
              <pre>${JSON.stringify(result, null, 2)}</pre>
            </div>
          `;
          
          // Reset form su successo
          clientForm.reset();
        } catch (error) {
          console.error('Errore:', error);
          
          resultDiv.innerHTML = `
            <div class="error">
              <h3>❌ Errore!</h3>
              <p>${error.message}</p>
              <p>Controlla la console per dettagli.</p>
            </div>
          `;
        }
        
        resultDiv.style.display = 'block';
      });
    });
  </script>
</body>
</html>