<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creazione Diretta Cliente</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        h1 {
            color: #2c3e50;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        form {
            margin-top: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select, textarea {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            cursor: pointer;
            font-size: 16px;
        }
        .response {
            margin-top: 20px;
            padding: 15px;
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .success {
            color: #2ecc71;
            font-weight: bold;
        }
        .error {
            color: #e74c3c;
            font-weight: bold;
        }
        pre {
            background-color: #f0f0f0;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <h1>Creazione Cliente Diretta con SQL</h1>
    <p>Questo form crea un nuovo cliente usando l'endpoint di emergenza con query SQL dirette, evitando il normale processo di validazione.</p>
    
    <form id="clientForm">
        <div class="form-group">
            <label for="type">Tipo Cliente*</label>
            <select id="type" name="type" required>
                <option value="buyer">Acquirente</option>
                <option value="seller">Venditore</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="salutation">Forma di Saluto</label>
            <select id="salutation" name="salutation">
                <option value="egr_dott">Egr. Dott.</option>
                <option value="gentma_sigra">Gent.ma Sig.ra</option>
                <option value="egr_avvto">Egr. Avv.to</option>
                <option value="caro">Caro</option>
                <option value="cara">Cara</option>
                <option value="ciao">Ciao</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="firstName">Nome*</label>
            <input type="text" id="firstName" name="firstName" required value="Mario">
        </div>
        
        <div class="form-group">
            <label for="lastName">Cognome*</label>
            <input type="text" id="lastName" name="lastName" required value="Rossi">
        </div>
        
        <div class="form-group">
            <label for="phone">Telefono*</label>
            <input type="text" id="phone" name="phone" required value="393331234567">
        </div>
        
        <div class="form-group">
            <label for="email">Email</label>
            <input type="email" id="email" name="email" value="mario@example.com">
        </div>
        
        <div class="form-group">
            <label for="religion">Religione</label>
            <input type="text" id="religion" name="religion" value="catholic">
        </div>
        
        <div class="form-group">
            <label for="isFriend">
                <input type="checkbox" id="isFriend" name="isFriend"> Cliente amico
            </label>
        </div>
        
        <!-- Campi per acquirente -->
        <div id="buyerFields">
            <h3>Dettagli Acquirente</h3>
            
            <div class="form-group">
                <label for="minSize">Superficie minima (mq)</label>
                <input type="number" id="minSize" name="minSize" value="50">
            </div>
            
            <div class="form-group">
                <label for="maxPrice">Prezzo massimo (€)</label>
                <input type="number" id="maxPrice" name="maxPrice" value="300000">
            </div>
            
            <div class="form-group">
                <label for="urgency">Urgenza (1-5)</label>
                <input type="number" id="urgency" name="urgency" min="1" max="5" value="3">
            </div>
            
            <div class="form-group">
                <label for="rating">Rating (1-5)</label>
                <input type="number" id="rating" name="rating" min="1" max="5" value="3">
            </div>
            
            <div class="form-group">
                <label for="searchNotes">Note ricerca</label>
                <textarea id="searchNotes" name="searchNotes" rows="3">Cerca zona centrale</textarea>
            </div>
        </div>
        
        <div class="form-group">
            <label for="notes">Note generali</label>
            <textarea id="notes" name="notes" rows="3">Cliente test creato via SQL diretto</textarea>
        </div>
        
        <button type="submit">Crea Cliente</button>
    </form>
    
    <div class="response" id="response" style="display: none;">
        <h3>Risposta API</h3>
        <div id="statusMessage"></div>
        <pre id="responseContent"></pre>
    </div>
    
    <script>
        // Mostra/nascondi campi buyer in base al tipo cliente
        document.getElementById('type').addEventListener('change', function() {
            const buyerFields = document.getElementById('buyerFields');
            buyerFields.style.display = this.value === 'buyer' ? 'block' : 'none';
        });
        
        // Gestione form
        document.getElementById('clientForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Raccolta dati form
            const formData = new FormData(this);
            const clientData = {
                type: formData.get('type'),
                salutation: formData.get('salutation'),
                firstName: formData.get('firstName'),
                lastName: formData.get('lastName'),
                isFriend: formData.get('isFriend') === 'on',
                email: formData.get('email') || '',
                phone: formData.get('phone'),
                religion: formData.get('religion') || '',
                notes: formData.get('notes') || ''
            };
            
            // Aggiungi dati buyer se necessario
            if (clientData.type === 'buyer') {
                // Crea poligono Milano centro come area di ricerca
                const searchArea = {
                    type: "Feature",
                    geometry: {
                        type: "Polygon",
                        coordinates: [
                            [
                                [9.163, 45.471],
                                [9.167, 45.456],
                                [9.184, 45.460],
                                [9.182, 45.470],
                                [9.174, 45.473],
                                [9.163, 45.471]
                            ]
                        ]
                    }
                };
                
                clientData.buyer = {
                    searchArea: searchArea,
                    minSize: parseInt(formData.get('minSize')) || null,
                    maxPrice: parseInt(formData.get('maxPrice')) || null,
                    urgency: parseInt(formData.get('urgency')) || 3,
                    rating: parseInt(formData.get('rating')) || 3,
                    searchNotes: formData.get('searchNotes') || ''
                };
            }
            
            try {
                // Invia richiesta all'API
                const response = await fetch('/api/clients/direct-sql', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(clientData)
                });
                
                // Ottieni risposta
                const result = await response.json();
                
                // Mostra risposta
                const responseDiv = document.getElementById('response');
                const statusMessage = document.getElementById('statusMessage');
                const responseContent = document.getElementById('responseContent');
                
                responseDiv.style.display = 'block';
                
                if (response.ok) {
                    statusMessage.className = 'success';
                    statusMessage.textContent = `✅ Cliente creato con successo! ID: ${result.client?.id || 'N/A'}`;
                } else {
                    statusMessage.className = 'error';
                    statusMessage.textContent = `❌ Errore: ${result.error || 'Errore nella creazione del cliente'}`;
                }
                
                responseContent.textContent = JSON.stringify(result, null, 2);
                
            } catch (error) {
                console.error('Errore:', error);
                
                const responseDiv = document.getElementById('response');
                const statusMessage = document.getElementById('statusMessage');
                const responseContent = document.getElementById('responseContent');
                
                responseDiv.style.display = 'block';
                statusMessage.className = 'error';
                statusMessage.textContent = `❌ Errore: ${error.message}`;
                responseContent.textContent = 'Si è verificato un errore durante la richiesta.';
            }
        });
        
        // Inizializza il form
        document.getElementById('type').dispatchEvent(new Event('change'));
    </script>
</body>
</html>