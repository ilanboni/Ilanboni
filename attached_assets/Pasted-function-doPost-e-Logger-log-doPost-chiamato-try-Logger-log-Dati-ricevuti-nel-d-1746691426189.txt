function doPost(e) {
  Logger.log("doPost chiamato");
  try {
    Logger.log("Dati ricevuti nel doPost: " + JSON.stringify(e));
    if (!e || !e.postData || !e.postData.contents) {
      Logger.log("Nessun dato postato trovato");
      return ContentService.createTextOutput("Nessun dato postato trovato").setMimeType(ContentService.MimeType.TEXT);
    }

    var requestData = JSON.parse(e.postData.contents);
    Logger.log("Dati JSON parsati: " + JSON.stringify(requestData));

    var result = addWhatsappToAttivita(requestData);
    return ContentService.createTextOutput(result).setMimeType(ContentService.MimeType.TEXT);
  } catch (error) {
    Logger.log("Errore nel doPost: " + error.message);
    return ContentService.createTextOutput("Errore: " + error.message).setMimeType(ContentService.MimeType.TEXT);
  }
}

function addWhatsappToAttivita(requestData) {
  try {
    var ss = SpreadsheetApp.openById('1qCYB05U2m7b1x_kJYjpYvZMzCCidaHOrQ1fTzWRy6YM');
    var sheetAttivita = ss.getSheetByName('Attività');
    var sheetClienti = ss.getSheetByName('Clienti');

    if (!sheetAttivita || !sheetClienti) {
      Logger.log("Uno o più fogli di calcolo non trovati. Assicurati che i nomi dei fogli siano corretti.");
      return "Errore: Uno o più fogli di calcolo non trovati.";
    }

    var clientiData = sheetClienti.getDataRange().getValues();

    var clientiMap = {};
    Logger.log("Inizio a costruire la mappa dei clienti.");
    for (var i = 1; i < clientiData.length; i++) {
      var telefono = clientiData[i][7]; // Assumendo che il telefono sia nella colonna H (indice 7)
      if (telefono) {
        clientiMap[telefono] = {
          idCliente: clientiData[i][0], // ID cliente nella colonna A
          nome: clientiData[i][4], // Nome nella colonna E
          cognome: clientiData[i][5], // Cognome nella colonna F
          mail: clientiData[i][6] // Mail nella colonna G
        };
        Logger.log("Aggiunto cliente: " + JSON.stringify(clientiMap[telefono]));
      }
    }

    var telefono = requestData.Telefono;
    Logger.log("Cerco il cliente con telefono: " + telefono);
    var cliente = clientiMap[telefono];

    if (cliente) {
      Logger.log("Cliente trovato: " + JSON.stringify(cliente));
      Logger.log("Aggiungo riga a Attività: " + JSON.stringify([
        '', // IdAttività (assegnato da AppSheet)
        requestData["Tipo attività"], // Tipo attività
        new Date(), // Data e ora (Now)
        '', // Oggetto mail
        requestData.Descrizione, // Descrizione (testo del whatsapp)
        cliente.idCliente, // IdCliente
        '', // IdImmobili (se necessario)
        telefono, // Telefono
        cliente.mail, // Mail
        cliente.nome, // Nome
        cliente.cognome // Cognome
      ]));
      sheetAttivita.appendRow([
        '', // IdAttività (assegnato da AppSheet)
        requestData["Tipo attività"], // Tipo attività
        new Date(), // Data e ora (Now)
        '', // Oggetto mail
        requestData.Descrizione, // Descrizione (testo del whatsapp)
        cliente.idCliente, // IdCliente
        '', // IdImmobili (se necessario)
        telefono, // Telefono
        cliente.mail, // Mail
        cliente.nome, // Nome
        cliente.cognome // Cognome
      ]);

      Logger.log("Messaggio aggiunto con successo nella tabella Attività.");
      return "Successo: Messaggio aggiunto con successo nella tabella Attività.";
    } else {
      Logger.log("Cliente non trovato per telefono: " + telefono);
      return "Errore: Cliente non trovato.";
    }
  } catch (error) {
    Logger.log("Errore nel addWhatsappToAttivita: " + error.message);
    return "Errore: " + error.message;
  }
}