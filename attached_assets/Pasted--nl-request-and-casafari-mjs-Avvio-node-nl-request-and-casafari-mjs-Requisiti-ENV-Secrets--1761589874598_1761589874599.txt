// nl_request_and_casafari.mjs
// Avvio: node nl_request_and_casafari.mjs
// Requisiti ENV (Secrets):
//   OPENAI_API_KEY
//   REPLIT_BASE_URL = https://cavourimmobiliare-ilanboni.replit.app
//   REPLIT_API_TOKEN
//   CASAFARI_API_TOKEN   (opzionale: se presente, prova a importare da Casafari Alerts)

import express from "express";
import bodyParser from "body-parser";

// ====== CONFIG ======
const PORT = process.env.PORT || 5050;
const OPENAI_API_KEY = (process.env.OPENAI_API_KEY || "").trim();
const REPLIT_BASE = (process.env.REPLIT_BASE_URL || "").replace(/\/$/, "");
const REPLIT_TOKEN = (process.env.REPLIT_API_TOKEN || "").trim();
const CASAFARI_TOKEN = (process.env.CASAFARI_API_TOKEN || "").trim();

if (!OPENAI_API_KEY || !REPLIT_BASE || !REPLIT_TOKEN) {
  console.error("❌ Missing Secrets. Setta OPENAI_API_KEY, REPLIT_BASE_URL, REPLIT_API_TOKEN (CASAFARI_API_TOKEN è opzionale).");
  process.exit(1);
}

const app = express();
app.use(bodyParser.json({ limit: "1mb" }));

// ====== HELPER HTTP ======
async function httpJson(url, opts = {}) {
  const r = await fetch(url, opts);
  if (!r.ok) {
    const t = await r.text().catch(() => "");
    throw new Error(`${opts.method || "GET"} ${url} → ${r.status} ${t}`);
  }
  // 204 no content
  if (r.status === 204) return null;
  return r.json();
}

// ====== 1) PARSE NL → FILTRI (ChatGPT) ======
async function nlToFiltersWithGPT(text) {
  const payload = {
    model: "gpt-4o-mini",
    response_format: { type: "json_object" },
    messages: [
      { role: "system", content: "Sei un assistente immobiliare. Estrai dati strutturati da una richiesta in italiano. Rispondi SOLO JSON valido." },
      {
        role: "user",
        content:
`Analizza questa richiesta immobiliare e restituisci un JSON con:
{
  "deal_type": "sale|rent",
  "property_type": "apartment|house|office|other",
  "budget_max": number|null,
  "size_min": number|null,
  "rooms": number|null,
  "bathrooms": number|null,
  "floor_min": number|null,
  "zones": string[] (nomi quartieri Milano se presenti),
  "condition": "to_renovate|new_or_renovated|null",
  "features": { "elevator": boolean, "balcony_or_terrace": boolean, "parking": boolean, "garden": boolean }
}
Testo: ${text}`
      }
    ]
  };

  const res = await httpJson("https://api.openai.com/v1/chat/completions", {
    method: "POST",
    headers: {
      Authorization: `Bearer ${OPENAI_API_KEY}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify(payload)
  });

  const content = res?.choices?.[0]?.message?.content || "{}";
  let parsed = {};
  try { parsed = JSON.parse(content); } catch { parsed = {}; }

  // default sensati
  if (!parsed.deal_type) parsed.deal_type = "sale";
  if (!parsed.property_type) parsed.property_type = "apartment";
  if (!parsed.features) parsed.features = {};
  if (!Array.isArray(parsed.zones)) parsed.zones = [];

  return parsed;
}

// ====== 2) SALVA RICHIESTA NEL TUO CRM ======
async function saveClientRequestToCRM(clientId, sourceText, filters) {
  // Prova endpoint nativo del tuo backend, altrimenti crea un task “CLIENT_REQUEST”
  // 2.1) tentativo: endpoint suggerito /api/client-requests (se esiste nel tuo backend)
  try {
    const r = await httpJson(`${REPLIT_BASE}/api/client-requests`, {
      method: "POST",
      headers: {
        Authorization: `Bearer ${REPLIT_TOKEN}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        client_id: clientId,
        source_text: sourceText,
        ...filters
      })
    });
    return { mode: "client_requests", result: r };
  } catch (e) {
    // 2.2) fallback: crea un task con i filtri in notes (sempre supportato)
    const notes = `CLIENT_REQUEST from NL\nclient_id=${clientId}\n${JSON.stringify(filters, null, 2)}`;
    const r2 = await httpJson(`${REPLIT_BASE}/api/tasks`, {
      method: "POST",
      headers: {
        Authorization: `Bearer ${REPLIT_TOKEN}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        type: "CLIENT_REQUEST",
        status: "open",
        priority: 70,
        client_id: clientId,
        notes
      })
    });
    return { mode: "task_fallback", result: r2 };
  }
}

// ====== 3) (OPZIONALE) IMPORT DA CASAFARI ALERTS → CRM ======
// Qui NON creiamo alert nuovi; leggiamo gli alert esistenti e importiamo i risultati.
// Se vuoi collegare i filtri NL a Casafari: crea alert su Casafari con quei filtri e dagli un nome = cliente.
async function importFromCasafariAlerts() {
  if (!CASAFARI_TOKEN) return { ok: false, reason: "no_token" };

  const authHeader = { Authorization: `Bearer ${CASAFARI_TOKEN}` };

  // elenca alert
  const alerts = await httpJson("https://api.casafari.com/v2/alerts", { headers: authHeader }) || { data: [] };
  const data = alerts?.data || [];
  let totalImported = 0;

  for (const a of data) {
    const id = a?.id;
    if (!id) continue;

    const url = `https://api.casafari.com/v2/alerts/${id}/results?limit=100&offset=0`;
    const results = await httpJson(url, { headers: authHeader }) || { data: [] };
    const items = (results.data || []).map((x) => {
      const attr = x?.attributes || {};
      const dup = Number(attr.duplicate_count ?? attr.cluster_size ?? 1);
      const ownerType = attr.is_private_owner ? "private" : "agency";
      return {
        listing_id: x?.id ?? "",
        title: attr.title ?? "",
        price_eur: attr.price ?? null,
        size_mq: attr.size ?? null,
        address: attr.address ?? attr.location_label ?? "",
        floor: attr.floor ?? "",
        url: attr.url ?? "",
        portal: attr.portal_name ?? attr.source ?? "",
        owner_type: ownerType,
        duplicate_count: Number.isFinite(dup) ? dup : 1,
        contact_phone: attr.contact_phone ?? "",
        contact_email: attr.contact_email ?? "",
        images: Array.isArray(attr.images) ? attr.images : [],
        source: "casafari-api",
        is_multiagency: (Number.isFinite(dup) ? dup : 1) >= 2,
      };
    });

    if (!items.length) continue;

    // invia al tuo backend per import dedup + match
    const resp = await httpJson(`${REPLIT_BASE}/api/import-casafari`, {
      method: "POST",
      headers: {
        Authorization: `Bearer ${REPLIT_TOKEN}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ items })
    });

    // avvia matching/task engine solo se qualcosa è entrato
    if (items.length > 0) {
      await fetch(`${REPLIT_BASE}/api/run/match`, {
        method: "POST",
        headers: { Authorization: `Bearer ${REPLIT_TOKEN}` }
      });
    }

    totalImported += items.length;
  }

  return { ok: true, imported: totalImported };
}

// ====== ENDPOINTS ======

// 1) Linguaggio naturale → richiesta salvata (+ eventuale import Casafari)
app.post("/api/clients/:id/nl-request", async (req, res) => {
  try {
    const clientId = String(req.params.id);
    const text = String(req.body?.text || "").trim();
    if (!text) return res.status(400).json({ error: "missing_text" });

    // a) NL → filtri
    const filters = await nlToFiltersWithGPT(text);

    // b) salva nel CRM (tabella client_requests se esiste, altrimenti task)
    const saved = await saveClientRequestToCRM(clientId, text, filters);

    // c) (opzionale) importa da Casafari i risultati degli alert esistenti
    let casafari = { ok: false, reason: "skipped" };
    if (CASAFARI_TOKEN) {
      casafari = await importFromCasafariAlerts();
    }

    return res.json({
      ok: true,
      client_id: clientId,
      filters,
      saved_mode: saved.mode,
      casafari_import: casafari
    });
  } catch (e) {
    return res.status(500).json({ error: String(e.message || e) });
  }
});

// 2) Trigger manuale “solo Casafari → CRM” (se vuoi farlo a parte)
app.post("/api/manual/casafari/pull", async (_req, res) => {
  try {
    if (!CASAFARI_TOKEN) return res.status(400).json({ error: "no_casafari_token" });
    const out = await importFromCasafariAlerts();
    return res.json(out);
  } catch (e) {
    return res.status(500).json({ error: String(e.message || e) });
  }
});

// ====== START ======
app.listen(PORT, () => {
  console.log(`✅ NL Request + Casafari bridge attivo su http://localhost:${PORT}`);
  console.log(`→ POST /api/clients/:id/nl-request  { text }`);
  console.log(`→ POST /api/manual/casafari/pull`);
});