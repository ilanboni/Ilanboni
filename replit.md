# Client Management System

## Overview
This project is a comprehensive real estate management system designed for property agents and clients. It provides a full-stack solution for managing properties, clients, communications, appointments, and automated workflows. Key capabilities include WhatsApp integration, Google Calendar synchronization, AI-powered assistance, and advanced property matching. The system aims to streamline operations for real estate professionals, enhance client interaction, and leverage AI for efficient property acquisition and management.

## User Preferences
Preferred communication style: Simple, everyday language.

## System Architecture
The application features a modern full-stack architecture.
- **Frontend**: React with TypeScript, Vite, Tailwind CSS, and shadcn/ui. It utilizes Wouter for routing, TanStack Query for server state, Leaflet for maps, and React Hook Form with Zod for forms.
- **Backend**: Express.js with TypeScript, running on Node.js.
- **Database**: PostgreSQL with Drizzle ORM.
- **UI/UX**: Utilizes shadcn/ui components built on Radix UI primitives, styled with Tailwind CSS for a consistent and modern design. Interactive maps are provided by Leaflet, and address geocoding is handled via Nominatim.
- **Technical Implementations**: OAuth2 for Google services (Calendar, Gmail), UltraMsg for WhatsApp integration, and OpenAI for AI features. The system includes a custom scheduler for automated follow-ups and advanced property deduplication and matching algorithms using image hashing and fuzzy string matching. It also features a virtual secretary for prioritized contact management and task generation.
- **Feature Specifications**:
    - **Client Management**: Detailed client profiles (buyers/sellers) with preferences.
    - **Property Management**: Comprehensive property listings, external property import from portals, and automatic identification of multi-agency properties.
    - **Communication**: Integrated WhatsApp and email communication tracking, with AI-powered response generation and automated reminders.
    - **Appointment Management**: Google Calendar synchronization, automated follow-ups, and conflict prevention.
    - **Task Automation**: AI-generated follow-up tasks, prioritized task dashboard, and automated workflows for property acquisition.
    - **Analytics**: Dashboard with daily goals, performance metrics, and AI insights.
    - **Data Correlation**: Smart correlation of communications, appointments, and properties.

## External Dependencies
- **@neondatabase/serverless**: PostgreSQL database connection
- **googleapis**: Google Calendar and Gmail API integration
- **@anthropic-ai/sdk**: AI assistant capabilities
- **axios**: HTTP client for external API calls
- **drizzle-orm**: Type-safe database ORM
- **@tanstack/react-query**: Server state management
- **leaflet**: Interactive maps
- **@turf/helpers**: Geographic calculations
- **sharp-phash**: Image hashing for deduplication
- **string-similarity**: Fuzzy matching for property deduplication
- **UltraMsg**: WhatsApp messaging integration
- **OpenAI SDK + Replit AI Integrations**: AI features using GPT-5 for natural language processing of client property requests (no personal API key required, billed to Replit credits via AI_INTEGRATIONS_OPENAI_BASE_URL and AI_INTEGRATIONS_OPENAI_API_KEY)
- **Nominatim**: Geocoding services
## Changelog
- October 30, 2025. **AI Preferences Integration in New Client Creation - Production Ready** - Integrated AI-powered natural language processing directly into new client creation workflow (/clients/direct-new): extended NLPreferencesInput component with standalone mode (works without existing clientId), created POST /api/nl-process endpoint for standalone AI extraction, extended database schema buyers table with 8 new fields (propertyType, rooms, bathrooms, zones, elevator, balconyOrTerrace, parking, garden) for persisting AI-extracted preferences, implemented form auto-population callback that prefills all fields when AI processes natural language text (e.g., "appartamento 160mq terrazzo zona Pagano budget 800k"). **Critical improvements applied**: (1) Unified all API calls to use apiRequest helper for consistent auth/error handling, (2) Fixed backend bug where AI fields weren't included in buyerData during POST /api/clients, (3) Updated all "Nuovo Cliente" navigation links (dashboard, clients page) to point to /clients/direct-new instead of legacy /clients/new, (4) Created comprehensive DB-level integration test verifying all 8 AI fields persist correctly (property_type, rooms, bathrooms, zones JSONB, elevator, balcony_or_terrace, parking, garden), end-to-end Playwright test passed with full database verification, architect-reviewed and approved production-ready implementation with complete data integrity validation
- October 29, 2025. **Integrazione NL Request in Pagina Cliente** - Integrato componente NLPreferencesInput direttamente nel tab Preferenze della pagina cliente: card viola "Compila Preferenze con AI" posizionata all'inizio del tab Preferenze per accesso rapido senza navigare su altra pagina, textarea con placeholder esplicativo per input linguaggio naturale (es: "appartamento 160mq terrazzo attico Pagano budget 800k"), bottone "Elabora con AI" chiama POST /api/clients/:id/nl-request e processa risposta con filtri camelCase (budgetMax, sizeMin, propertyType, zones, features), costruisce query params e naviga a /clients/:id/search?maxPrice=800000&minSize=160&ai_assisted=true, pagina search legge URL params e precompila automaticamente form (slider prezzo 800.000€, slider metratura 160mq), gestione errori robusta con toast notifications, fix camelCase mapping (era snake_case causando parametri errati), testing Playwright end-to-end completato con successo (verifica textarea input → AI processing → navigation → form prefill 800k/160mq), architect-approved production-ready al 100%
- October 29, 2025. **Interfaccia UI Richieste Linguaggio Naturale** - Creata pagina frontend `/clients/nl-request` per inserimento richieste immobiliari clienti in linguaggio naturale: form intuitivo con dropdown selezione cliente acquirente e textarea per descrizione libera (es: "appartamento 160mq con terrazzo, attico, zone Pagano/Porta Romana"), integrazione completa con backend POST /api/clients/:id/nl-request esistente, visualizzazione real-time filtri estratti dall'AI (card verde con badge per zone/caratteristiche/metratura/budget), display risultati matching con conteggio immobili compatibili, gestione robusta errori con optional chaining e fallback graceful, link "Nuova Richiesta AI" aggiunto in sidebar per accesso rapido, fix backend per includere matchingProperties in risposta API (era assente causando crash frontend), testing Playwright end-to-end completato con successo (verifica form submission, AI extraction, empty state handling), architect-approved production-ready al 100%
- October 28, 2025. **Raggruppamento Intelligente Immobili Multi-Agency** - Implementato sistema di clustering avanzato per immobili pluricondivisi nel tab "Pluricondivisi Milano": algoritmo normalizzazione indirizzi robusto (gestisce varianti v./v.le/vle, c.so/cso, p.za/pza, rimuove accenti, case-insensitive), endpoint GET /api/reports/multiagency-properties con filtro città case-insensitive (LOWER), validazione indirizzi vuoti/invalidi con skip automatico, calcolo metriche aggregate accurate (avgPrice, minPrice, maxPrice, avgSize reale su tutti membri cluster), componente ClusterCard con Dialog espandibile mostrante tutti annunci raggruppati per indirizzo (portale, prezzo, metratura), testing Playwright completato (5 cluster Milano verificati: Via Monte Rosa, Via Dante, Via Ponte Vetero, Via Torino, Corso Buenos Aires), architect-approved production-ready al 100%
- October 28, 2025. **Sistema Report Acquisizione Automatica** - Implementato sistema completo di report automatici per acquisizione immobili: creati 3 endpoint API (GET /api/reports/high-priority-matches per richieste rating 4-5 con match immobili + evidenza pluricondivisi, GET /api/reports/multiagency-properties per tutti i pluricondivisi Milano inclusi privato+agenzia, GET /api/reports/private-properties per immobili con contatto diretto proprietario), sviluppata pagina frontend `/reports/acquisitions` con 3 tab interattivi usando Tabs shadcn/ui, integrati pulsanti WhatsApp automatico per contatto diretto proprietari, testing end-to-end Playwright completato con successo (verificati navigation, tab switching, empty states, WhatsApp buttons), sistema operativo al 100% e production-ready
- October 28, 2025. **Sistema Ingestion Multi-Portale Automatico** - Implementata architettura completa per import automatico da portali immobiliari italiani: esteso schema database con metadata tracking (externalId, source, firstSeenAt, lastSeenAt, url), creato `portalIngestionService.ts` con adapter pattern, implementati 3 adapter (Idealista HTTP, Immobiliare HTTP, Immobiliare Playwright), creato `ingestionScheduler.ts` con orchestrazione automatica (cadenza 1 giorno), integrazione completa con deduplicationScheduler esistente, 3 endpoint API protetti (/api/admin/ingestion/status, /run, /portal/:id). **LIMITAZIONE CRITICA**: I portali italiani (Immobiliare.it, Idealista.it) usano protezioni anti-bot aggressive (DataDome) che bloccano scraping automatico. **Soluzione Playwright** implementata ma richiede `npx playwright install` per funzionare. **Alternative funzionanti**: (1) Import manuale via POST /api/import-casafari (già operativo), (2) Richiesta API ufficiali portali (Idealista Partner API, Immobiliare Realitycs API), (3) Servizi a pagamento (Apify ~€1/1000 annunci). Sistema architetturalmente production-ready, ma acquisizione dati bloccata da anti-bot - serve API ufficiali o servizi esterni per funzionamento completo.
- October 27, 2025. Interfaccia Visuale Deduplicazione Immobili completata - Implementata nuova pagina /properties/duplicates con visualizzazione cluster duplicati multi-agency, endpoint GET /api/deduplication/results che restituisce proprietà raggruppate per indirizzo con conteggio duplicati, bottone scansione manuale POST /api/run/scan protetto da autenticazione Bearer (VITE_REPLIT_API_TOKEN), scheduler automatico ogni 7 giorni con lock anti-concorrenza (flag isScanRunning), UI responsive con card per ogni cluster mostrando indirizzo/città/prezzo/mq/badge multi-agency, ordinamento per duplicateCount descending, test end-to-end completato con successo (3 cluster trovati: Via Ponte Vetero, Viale Belisario), sistema production-ready
- October 27, 2025. Sistema Natural Language Processing per richieste immobiliari completato - Implementato sistema completo di elaborazione richieste clienti in linguaggio naturale con ChatGPT: esteso schema database con tabella client_requests (clientId, sourceText, filters jsonb), creato servizio nlProcessingService.ts con OpenAI GPT-4o-mini per parsing NL→filtri strutturati (deal_type, property_type, budget_max, size_min, rooms, bathrooms, floor_min, zones, condition, features), implementati 3 endpoint API (POST /api/clients/:id/nl-request per NL→filtri→salva→match, POST /api/import-casafari per import array proprietà Casafari, POST /api/manual/casafari/pull per fetch automatico da Casafari Alerts API), sistema include graceful degradation con filtri default se OpenAI fallisce, integrazione completa con sistema matching esistente, workflow testato con richiesta "bilocale/trilocale 2 bagni piano ≥3 balcone ascensore 80mq €500k Isola/Porta Romana", sistema operativo al 100% e pronto per uso con API key OpenAI valida o integrazione Replit AI
- October 22, 2025. Sistema Segretaria Virtuale CRM+CMS completato - Implementato sistema completo di gestione prioritizzata contatti per acquisizione immobili pluricondivisi: esteso schema database (contacts, matches, priority/direction in tasks/interactions), create 9 API backend, implementata logica priorità automatica (privati 90-100, multi-agency 70-80, mono-agency 40-60), creati templates messaggi WhatsApp/phone/email con tone profiles, sviluppate 2 pagine frontend React, sistema operativo al 100%
