# Client Management System

## Overview
This project is a comprehensive real estate management system designed to streamline operations for property agents and enhance client interaction. It provides a full-stack solution for managing properties, clients, communications, and appointments. Key capabilities include WhatsApp integration, Google Calendar synchronization, AI-powered assistance for property matching and client interaction, and automated workflows for property acquisition and management. The system aims to leverage AI to improve efficiency and client satisfaction in the real estate sector, with a focus on comprehensive property data aggregation and intelligent client-property matching.

## User Preferences
Preferred communication style: Simple, everyday language.

## System Architecture
The application features a modern full-stack architecture.
- **Frontend**: React with TypeScript, Vite, Tailwind CSS, shadcn/ui, Wouter for routing, TanStack Query for server state, Leaflet for maps, and React Hook Form with Zod for form management. It includes mobile-responsive optimizations.
- **Backend**: Express.js with TypeScript, running on Node.js.
- **Database**: PostgreSQL with Drizzle ORM.
- **UI/UX**: Utilizes shadcn/ui components built on Radix UI, styled with Tailwind CSS. Interactive maps are provided by Leaflet, and geocoding by Nominatim. The UI emphasizes a card-based interface with color-coded visual cues for property status.
- **Technical Implementations**: OAuth2 for Google services, UltraMsg for WhatsApp integration, and OpenAI for AI features. The system includes a custom scheduler, advanced property deduplication and matching algorithms using image hashing and fuzzy string matching, and a virtual secretary for prioritized contact management and task generation. It also features an advanced multi-agency property clustering system with intelligent filtering, and automated reporting for property acquisition. Agency name normalization is used for accurate classification. An "Ignore" functionality for shared properties allows agents to dismiss unwanted listings. The system supports viewing of all matching competitor properties with accurate geographic filtering using FeatureCollection for multi-zone buyer searches. An automatic zone geocoding system uses Nominatim API to visualize buyer search areas.
    - **WhatsApp Message Deduplication**: 3-tier deduplication system prevents message triplication from racing webhooks. Pre-creates communication records before API calls to avoid race conditions. Tier 1: externalId matching, Tier 2: correlationId (UUID) matching, Tier 3: content+time matching (workaround for UltraMsg not returning referenceId). Tracks source ('app', 'phone', 'webhook') and deliveryStatus ('pending' → 'sent' → 'delivered' for outbound, 'received' for inbound). Database columns: correlationId (UUID, indexed), source (TEXT), deliveryStatus (TEXT), externalId (TEXT). **Property Context Threading**: WhatsApp webhook automatically inherits sharedPropertyId from last outbound communication when client replies, ensuring complete conversation threads are visible on property detail pages. This dual-activity tracking links client responses to both the client profile and the specific shared property discussed.
    - **WhatsApp Property Sending with Dual-Mode Safety System**: Feature for sending shared properties via WhatsApp with customizable messages and agency link selection. **Dual-Mode Configuration**: System operates in two modes controlled by WHATSAPP_MODE environment variable: (1) **Test Mode** (default, no env var or WHATSAPP_MODE=test): Backend blocks all sends except to test number (393407992052/Ilan Boni), frontend shows yellow "Modalità Test" alert and filters client dropdown to show only test client, no confirmation checkbox required. (2) **Production Mode** (WHATSAPP_MODE=production): Backend allows sends to all clients, frontend shows orange "⚠️ Modalità Produzione" alert with mandatory double-confirmation checkbox ("Confermo di voler inviare..."), client dropdown shows all clients, send button disabled until checkbox is checked. **Mode Detection**: Frontend fetches system configuration from GET /api/config endpoint which exposes whatsappMode ('test' or 'production'), TEST_PHONE_NUMBER (393407992052), and WEBHOOK_FORWARDER_KEY. Checkbox state (prodModeConfirmed) resets automatically when dialog closes. The send-to-client dialog allows: client selection, agency checkbox selection (multiple agencies per property), custom message composition, real-time preview of formatted WhatsApp message, and triple-tracking (creates client communication record + property activity + completed client task). Message format: custom text followed by selected agency URLs (no agency names for cleaner presentation).
- **Feature Specifications**:
    - **Client Management**: Detailed client profiles with AI-extracted preferences.
    - **Property Management**: Comprehensive listings, external import, and multi-agency property identification with refined deduplication.
    - **Communication**: Integrated WhatsApp and email tracking with AI-powered response generation and automated reminders, including a WhatsApp Web-style chat interface.
    - **Appointment Management**: Google Calendar synchronization, automated follow-ups, and conflict prevention. Appointments are created with automatic Google Calendar sync and reminders, supporting a dual-table architecture for backwards compatibility. **OAuth Token Management**: Robust error handling for expired/revoked Google Calendar tokens - automatically detects `invalid_grant` errors, invalidates stale tokens, marks affected events as 'needs_auth', and displays reconnection banner across all pages. Events created while disconnected are immediately marked for reauthorization to ensure seamless sync recovery after reconnection.
    - **Task Automation**: AI-generated follow-up tasks, prioritized dashboards, and automated workflows for property acquisition, including a multi-agency property acquisition workflow with a 5-stage pipeline visualization. Task management includes an activity timeline, detailed task editing pages, and direct task creation from client pages.
    - **Property Acquisition Management**: Comprehensive tracking system for favorite properties with dedicated tabs for activities and documents. Features include: timeline-based activity tracking (phone calls, site visits, emails, document requests, negotiations) with create/edit/delete operations; document management with drag-and-drop file upload, categorization (visura, planimetria, foto, contratto, altro), and secure download; full Zod schema validation for data integrity; path traversal protection with filename sanitization for security; real-time UI updates with TanStack Query cache invalidation; and integration with existing property pipeline visualization.
    - **Analytics**: Dashboard with daily goals, performance metrics, and AI insights.
    - **Data Correlation**: Smart correlation of communications, appointments, and properties.
    - **Natural Language Processing (NLP)**: AI-driven processing of client property requests, extracting structured filters.
    - **Automated Property Ingestion**: Architecture for automatic import from real estate portals, utilizing the Casafari API.
    - **Automated Property Scraping**: Optimized full-city scraping scheduler (Martedì e Venerdì alle 2:00 AM Europe/Rome timezone) that downloads ALL properties from Milano using a single Apify call instead of per-buyer scraping. The system performs one complete scrape of the entire city and lets the existing matching/filtering system handle buyer-specific criteria server-side. This approach is significantly more efficient than N separate scraping jobs per buyer, reducing API calls by 100x+ and eliminating redundant downloads. **Architecture**: Uses `FullCityScrapingScheduler` with `apifyService.scrapeAllMilano()` for comprehensive city-wide coverage, imports via `ingestionService.importProperty()` for proper type handling, and includes duplicate prevention (skips if executed within last 12 hours). Properties are filtered per buyer using server-side matching logic (`isPropertyMatchingBuyerCriteria` in `server/lib/matchingLogic.ts`) based on stored buyer criteria (propertyType, rooms, zones, price, size, etc.). **Zone Filtering**: Applied server-side during filtering - zone criteria are stored in buyer profiles as FeatureCollection GeoJSON and matched using Turf.js point-in-polygon checks. Uses node-cron with explicit Europe/Rome timezone for reliable scheduling. **Instant Property Filtering**: Users filter properties from the database for individual buyers via "Cerca Immobili" button (formerly "Scraping Mirato"). This provides instant results (~100ms) by querying GET `/api/properties/for-buyer/:clientId` which filters all stored properties (both normal and shared) server-side using `isPropertyMatchingBuyerCriteria`. The endpoint returns a structured response object `{ success: boolean, total: number, properties: Property[], buyerCriteria: {...} }`. **Shared Properties Integration**: Shared properties from the multi-agency table are converted to Property format with proper field mapping to ensure they pass all filtering guards: `status: sp.status ?? 'available'` (prevents rejection by availability guard), `location: sp.location` (required for searchArea polygon filtering), and `type: sp.type` (for property type matching). This unified filtering approach allows buyers to see both normal and shared properties matching their criteria. Frontend uses typed `MatchingPropertiesResponse` interface for type safety, with TanStack Query caching the full response object for consistency between initial fetches and mutation updates. Components access properties via `matchingProperties?.properties ?? []` pattern. This approach is significantly faster (instant vs 10+ minutes) and more cost-effective than per-buyer Apify calls, leveraging the existing full-city dataset. Cache invalidation uses the unified query key `['/api/properties/for-buyer', id]` for all operations.
    - **Property Deduplication**: Consolidates all duplicate listings into single cards regardless of agency, using normalized agency names and address/price grouping. **Performance Optimization**: Implements intelligent bucketing algorithm that reduces comparisons by 95.9% (from O(n²) 16.5M to 673K comparisons) through geographic bucketing (0.01° grid ≈1km with 3×3 overlap) and price bucketing (50k bands with ±1 overlap). Each property is placed in 27 buckets (9 geographic × 3 price) to ensure properties near bucket boundaries are still compared. Completes in ~14 seconds vs previous 2-3 minutes, well under Neon's 103-second connection timeout. Uses Set-based deduplication to avoid redundant comparisons within overlapping buckets. Batch inserts 100 records at a time using ON CONFLICT constraint on address+price.
    - **Private Properties Section**: Dedicated page (`/properties/private`) for viewing properties sold directly by private owners (non-agencies) within 4km radius of Milan's Duomo. Features multi-layered filtering: ownerType validation, Apify source verification (Immobiliare.it/Idealista.it), geographic filtering using Haversine distance calculation from Duomo coordinates (45.464204, 9.191383), optional phone number filter, portal-specific filtering, text search, and multi-criteria sorting. Implements performance optimization with useMemo for filtered/sorted results, robust coordinate validation (handling null/undefined/empty/NaN), and awaited query invalidation for real-time UI updates. **Classification Logic**: Uses authoritative `analytics.advertiser` field from Apify (values: "agenzia" or "privato") with fallback to `contacts.agencyId`/`contacts.agencyName` when advertiser field is missing. For genuine private sellers, extracts owner contact data: `ownerPhone` from `contacts.phones[0].num`, `ownerName` from `analytics.advertiserName`, `ownerEmail` from `contacts.email`. The ingestion pipeline's UPDATE logic persists all owner metadata fields (`ownerType`, `agencyName`, `ownerName`, `ownerPhone`, `ownerEmail`) to ensure backfill scrapes correct previously misclassified listings.
    - **WhatsApp Webhook Diagnostic Tool**: A page to verify and configure UltraMsg webhook for automatic message synchronization.

## External Dependencies
- **@neondatabase/serverless**: PostgreSQL database connection
- **googleapis**: Google Calendar and Gmail API integration
- **@anthropic-ai/sdk**: AI assistant capabilities
- **axios**: HTTP client for external API calls
- **drizzle-orm**: Type-safe database ORM
- **@tanstack/react-query**: Server state management
- **leaflet**: Interactive maps
- **@turf/helpers**: Geographic calculations
- **sharp-phash**: Image hashing for deduplication
- **string-similarity**: Fuzzy matching for property deduplication
- **UltraMsg**: WhatsApp messaging integration
- **OpenAI SDK + Replit AI Integrations**: AI features
- **Apify**: Web scraping platform for automated property data collection from Immobiliare.it and Idealista.it
- **Nominatim**: Geocoding services for search area visualization
- **multer**: File upload middleware for property attachments with security constraints (50MB limit, allowed MIME types)
- **node-cron**: Cron-based task scheduler for automated buyer scraping